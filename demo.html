<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>語音↔文字 Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f5f7fa; }
    .voiceselect { min-width: 160px; }
  </style>
</head>
<body class="p-6 font-sans">
  <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-6 space-y-6">
    <h1 class="text-2xl font-bold">語音轉文字 &amp; 文字轉語音 Demo</h1>

    <section class="p-4 border rounded-lg space-y-3">
      <h2 class="font-semibold">語音辨識（Speech-to-Text）</h2>
      <div class="flex gap-3 items-center">
        <button id="startBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg">開始辨識</button>
        <button id="stopBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg" disabled>停止辨識</button>
        <div id="status" class="text-sm">狀態：未啟動</div>
      </div>
      <div>
        <label class="block font-medium">辨識文字（可編輯）：</label>
        <textarea id="transcript" rows="5" class="w-full border rounded p-2" placeholder="語音轉文字結果會出現在這裡"></textarea>
      </div>
      <div class="flex gap-2">
        <button id="downloadTranscript" class="px-4 py-2 bg-blue-500 text-white rounded">下載文字</button>
        <button id="clearTranscript" class="px-4 py-2 bg-gray-200 rounded">清除</button>
      </div>
      
    </section>

    <section class="p-4 border rounded-lg space-y-3">
      <h2 class="font-semibold">文字轉語音（Text-to-Speech）</h2>
      <div>
        <label class="block font-medium">要朗讀的文字：</label>
        <textarea id="ttsInput" rows="4" class="w-full border rounded p-2" placeholder="輸入或用辨識結果填入"></textarea>
      </div>
      <div class="flex flex-wrap gap-3 items-center">
        <div>
          <label class="block text-sm">語音選擇：</label>
          <select id="voiceSelect" class="border rounded p-1 voiceselect"></select>
        </div>
        <div>
          <label class="block text-sm">語速：</label>
          <input id="rate" type="range" min="0.5" max="2" step="0.1" value="1" /> <span id="rateVal">1</span>
        </div>
        <div>
          <label class="block text-sm">音調：</label>
          <input id="pitch" type="range" min="0" max="2" step="0.1" value="1" /> <span id="pitchVal">1</span>
        </div>
      </div>
      <div class="flex gap-2 mt-2">
        <button id="speakBtn" class="px-4 py-2 bg-indigo-600 text-white rounded">朗讀</button>
        <button id="stopSpeakBtn" class="px-4 py-2 bg-gray-300 rounded">停止</button>
        <button id="copyTranscript" class="px-4 py-2 bg-green-500 text-white rounded">填入辨識結果</button>
      </div>
      <p class="text-xs text-gray-600">使用瀏覽器的 speechSynthesis API 來進行文字朗讀。</p>
    </section>

    
  </div>

  <script>
    // 語音辨識初始化
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusEl = document.getElementById("status");
    const transcriptEl = document.getElementById("transcript");
    const downloadBtn = document.getElementById("downloadTranscript");
    const clearBtn = document.getElementById("clearTranscript");
    const copyBtn = document.getElementById("copyTranscript");
    const ttsInput = document.getElementById("ttsInput");
    const speakBtn = document.getElementById("speakBtn");
    const stopSpeakBtn = document.getElementById("stopSpeakBtn");
    const voiceSelect = document.getElementById("voiceSelect");
    const rateSlider = document.getElementById("rate");
    const pitchSlider = document.getElementById("pitch");
    const rateVal = document.getElementById("rateVal");
    const pitchVal = document.getElementById("pitchVal");

    let recognition = null;
    let isRecognizing = false;
    let finalTranscript = "";

    function setupRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        statusEl.textContent = "此瀏覽器不支援語音辨識。請使用 Chrome 或 Edge。";
        startBtn.disabled = true;
        return;
      }
      recognition = new SpeechRecognition();
      recognition.lang = "zh-TW";
      recognition.interimResults = true;
      recognition.continuous = true;

      recognition.onstart = () => {
        isRecognizing = true;
        statusEl.textContent = "正在聆聽...";
        startBtn.disabled = true;
        stopBtn.disabled = false;
      };
      recognition.onerror = (e) => {
        console.error("Recognition error", e);
        statusEl.textContent = "辨識錯誤: " + (e.error || "未知");
      };
      recognition.onend = () => {
        isRecognizing = false;
        statusEl.textContent = "已停止";
        startBtn.disabled = false;
        stopBtn.disabled = true;
      };
      recognition.onresult = (event) => {
        let interim = "";
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          const result = event.results[i];
          if (result.isFinal) {
            finalTranscript += result[0].transcript;
          } else {
            interim += result[0].transcript;
          }
        }
        transcriptEl.value = finalTranscript + interim;
      };
    }

    setupRecognition();

    startBtn.addEventListener("click", () => {
      if (recognition && !isRecognizing) {
        finalTranscript = "";
        transcriptEl.value = "";
        recognition.start();
      }
    });
    stopBtn.addEventListener("click", () => {
      if (recognition && isRecognizing) recognition.stop();
    });
    clearBtn.addEventListener("click", () => {
      finalTranscript = "";
      transcriptEl.value = "";
    });
    downloadBtn.addEventListener("click", () => {
      const text = transcriptEl.value;
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "transcript.txt";
      a.click();
      URL.revokeObjectURL(url);
    });
    copyBtn.addEventListener("click", () => {
      ttsInput.value = transcriptEl.value;
    });

    // TTS voices list
    function populateVoices() {
      const voices = speechSynthesis.getVoices();
      voiceSelect.innerHTML = "";
      voices.forEach(v => {
        const o = document.createElement("option");
        o.value = v.name + "||" + v.lang;
        o.textContent = `${v.name} (${v.lang})${v.default ? ' [預設]' : ''}`;
        voiceSelect.appendChild(o);
      });
    }
    populateVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = populateVoices;
    }
    rateSlider.addEventListener("input", () => { rateVal.textContent = rateSlider.value; });
    pitchSlider.addEventListener("input", () => { pitchVal.textContent = pitchSlider.value; });

    speakBtn.addEventListener("click", () => {
      const text = ttsInput.value.trim();
      if (!text) return;
      if (!window.speechSynthesis) {
        alert("此瀏覽器不支援文字轉語音");
        return;
      }
      speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      // 選語音
      const sel = voiceSelect.value;
      if (sel) {
        const [name, lang] = sel.split("||");
        const voices = speechSynthesis.getVoices();
        const match = voices.find(v => v.name === name && v.lang === lang);
        if (match) utter.voice = match;
      }
      utter.rate = parseFloat(rateSlider.value);
      utter.pitch = parseFloat(pitchSlider.value);
      utter.lang = "zh-TW"; // 預設語言
      speechSynthesis.speak(utter);
    });
    stopSpeakBtn.addEventListener("click", () => { speechSynthesis.cancel(); });

    // 快速把辨識結果貼到朗讀欄
    transcriptEl.addEventListener("input", () => {
      // optional: 自動同步
    });
  </script>
</body>
</html>
